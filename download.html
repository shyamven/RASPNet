<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RASPNet - Download</title>
  <link rel="stylesheet" href="css/styles.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    .grid-container {
      display: grid;
      grid-template-columns: repeat(10, 30px);
      gap: 5px;
      margin-bottom: 10px;
    }
    .grid-item {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    .grid-item.selected {
      background-color: #add8e6;
    }
    .short-input {
      width: 60px;
    }
    .inputs-container {
      display: flex;
      flex-direction: column;
      margin-left: 20px;
      gap: 15px;
    }
    .input-label {
      margin-bottom: 5px;
    }
    .button-container {
      margin-top: 10px;
    }
    .square-button {
      width: 150px;
      height: 30px;
      font-size: 1em;
    }
    /* Folder selection row styling */
    .folder-selection-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .folder-path {
      width: 150px;
      height: 30px;
      padding: 5px;
      border: 1px solid #ccc;
      background-color: #fff;
      font-size: 1em;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    /* Styling for the enhanced progress container */
    #progress-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #f0f0f0;
      border-top: 1px solid #ccc;
      padding: 10px;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    #progress-bar {
      width: 80%;
      height: 20px;
      margin: 5px auto;
      display: block;
    }
    #time-info {
      margin-top: 5px;
      font-size: 0.9em;
      color: #333;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">RASPNet</div>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="download.html">Download</a></li>
        <li><a href="about.html">About</a></li>
      </ul>
    </nav>
  </header>
  <main>
    <!-- CLUTTER Dataset Section -->
    <h1>Download RASPNet</h1>
    
    <h2>CLUTTER Dataset</h2>
    <p>
      The CLUTTER dataset comprises 100 radar scenarios, each consisting of 10,000 clutter realizations, and can be accessed <a href="https://app.globus.org/file-manager?origin_id=b01166a6-0526-454a-aaff-943c7fada5d4&origin_path=%2FCLUTTER%2F">here</a>.
    </p>
    <p>
      To download RASPNet scenarios, first select a directory where you wish to save the files, then choose the scenario index and specify the range of clutter realizations to extract, \( j \in \{ j_{min},j_{min}+1,\ldots,j_{max}\}\). <br />
      When you click "Extract Dataset", a subdirectory named <code>num<em>i</em>_lat<em>lat</em>_lon<em>lon</em></code> will be created in your chosen directory, and the realization files will be saved inside.
    </p>
    
    <div style="display: flex; align-items: flex-start;">
      <!-- Left column: Scenario Grid -->
      <div>
        <label>Scenario Index, \(i \in \{1,2,\ldots,100\}\):</label>
        <div class="grid-container" id="grid-container">
          <!-- Grid items will be generated by JavaScript -->
        </div>
      </div>
      <!-- Right column: Inputs -->
      <div class="inputs-container">
        <!-- Folder Selection Row -->
        <div class="folder-selection-row">
          <br /> 
          <button id="select-directory" class="square-button">Select Directory</button>
          <input type="text" id="folder-path" class="folder-path" readonly placeholder="" />
        </div>
        <!-- Realization min index -->
        <div>
          <label for="realization-min-index" class="input-label">
            Realization min index, <br /> \(j_{min} \in \{1,2,\ldots,10{,}000\}\):
          </label>
          <input type="text" id="realization-min-index" name="realization-min-index" class="short-input" />
        </div>
        <!-- Realization max index -->
        <div>
          <label for="realization-max-index" class="input-label">
            <br />Realization max index,  <br /> \(j_{max} \in \{j_{min},j_{min}+1,\ldots,10{,}000\}\):
          </label>
          <input type="text" id="realization-max-index" name="realization-max-index" class="short-input" />
        </div>
        <!-- Extract Dataset Button -->
        <div class="button-container">
          <button id="extract-dataset" class="square-button">Extract Dataset</button>
        </div>
      </div>
    </div>

    <!-- CVNN Dataset Section -->
    <h2>CVNN Dataset</h2>
    <p>
      The CVNN dataset comprises ZIP files consisting of feature-label pairs for five radar scenarios from RASPNet, \( i \in \{29,35,60,62,76\} \). The code example for this dataset can be found <a href="https://github.com/shyamven/RASPNet/blob/main/Localization_Examples/RASPNet_CVNN.ipynb">here</a>.<br />
      Please note that the <b>Full Download</b> option first creates the .zip file containing all feature-label pairs before downloading. To download individual feature-label pairs, please use the <b>CVNN Dataset Link</b>.
    </p>
    <ul>
      <li>
        <a href="#" id="full-download-cvnn">Full Download</a>
      </li>
      <li>
        <a href="https://app.globus.org/file-manager?origin_id=b01166a6-0526-454a-aaff-943c7fada5d4&origin_path=%2FCVNN%2F&two_pane=false">CVNN Dataset Link</a>
      </li>
    </ul>

    <!-- EXAMPLES Dataset Section -->
    <h2>EXAMPLES Dataset</h2>
    <p>
      The EXAMPLES dataset comprises feature-label pairs for five radar scenarios from RASPNet, \( i \in \{29,35,60,62,76\} \). The code examples for the EXAMPLES dataset can be found <a href="https://github.com/shyamven/RASPNet">here</a>.<br />
      Please note that the <b>Full Download</b> option first creates the .zip file containing all feature-label pairs before downloading. To download individual feature-label pairs, please use the <b>EXAMPLES Dataset Link</b>.
    </p>
    <ul>
      <li><a href="#" id="full-download">Full Download</a></li>
      <li><a href="https://app.globus.org/file-manager?origin_id=b01166a6-0526-454a-aaff-943c7fada5d4&origin_path=%2FEXAMPLES%2F">EXAMPLES Dataset Link</a></li>
    </ul>

    <!-- Enhanced Progress Container -->
    <div id="progress-container" style="display:none;">
      <p>Downloading files ...</p>
      <progress id="progress-bar" value="0" max="100"></progress>
      <p id="time-info"></p>
    </div>
  </main>
  <footer>
    <p xmlns:cc="http://creativecommons.org/ns/" xmlns:dct="http://purl.org/dc/terms/">
      <a property="dct:title" rel="cc:attributionURL" href="http://shyamven.github.io/RASPNet/">RASPNet</a> 
      by <a rel="cc:attributionURL dct:creator" property="cc:attributionName" href="http://shyamven.github.io">
      Shyam Venkatasubramanian, Bosung Kang, Ali Pezeshki, Muralidhar Rangaswamy, Vahid Tarokh</a> 
      is licensed under 
      <a href="https://creativecommons.org/licenses/by/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">
        CC BY 4.0
        <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" alt="" />
        <img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" alt="" />
      </a>
    </p>
  </footer>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Global progress and timing variables.
      var progressContainer = document.getElementById("progress-container");
      var progressBar = document.getElementById("progress-bar");
      var timeInfo = document.getElementById("time-info");
      var totalFiles = 0;
      var processedFiles = 0;
      var startTime = null;

      // Global variable for the chosen directory (FileSystemDirectoryHandle)
      let selectedDirectoryHandle = null;
      const folderPathInput = document.getElementById("folder-path");

      // Helper function to format seconds as "Xm Ys".
      function formatTime(seconds) {
        var minutes = Math.floor(seconds / 60);
        var secs = Math.floor(seconds % 60);
        return minutes + "m " + secs + "s";
      }

      function updateProgress() {
        processedFiles++;
        var progress = (processedFiles / totalFiles) * 100;
        progressBar.value = progress;

        // Calculate elapsed and remaining time.
        var now = new Date();
        var elapsedSeconds = (now - startTime) / 1000;
        var estimatedTotal = processedFiles > 0 ? (elapsedSeconds / processedFiles) * totalFiles : 0;
        var remainingSeconds = estimatedTotal - elapsedSeconds;
        timeInfo.innerText = "Elapsed: " + formatTime(elapsedSeconds) + " | Remaining: " + formatTime(remainingSeconds);
      }

      // Function to fetch a file from URL and write it to a given directory handle.
      async function fetchAndWrite(url, dirHandle) {
        const response = await fetch(url);
        const blob = await response.blob();
        // Extract filename from URL (e.g. "real123.mat")
        const fileName = url.split('/').pop();
        // Create (or get) a file handle for writing.
        const fileHandle = await dirHandle.getFileHandle(fileName, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(blob);
        await writable.close();
        updateProgress();
      }

      // --- CLUTTER Dataset: Directory selection and extraction ---
      const selectDirButton = document.getElementById("select-directory");
      selectDirButton.addEventListener("click", async function() {
        try {
          // Opens a directory picker and stores the handle.
          selectedDirectoryHandle = await window.showDirectoryPicker();
          selectDirButton.innerText = "Select Directory";
          // Display the directory name (or truncated path) in the text box.
          folderPathInput.value = selectedDirectoryHandle.name;
        } catch (err) {
          console.error("Directory selection cancelled or failed", err);
        }
      });

      // Create the grid for scenario selection.
      var selectedScenarioIndex = null;
      var gridContainer = document.getElementById("grid-container");
      for (let i = 1; i <= 100; i++) {
        var gridItem = document.createElement("div");
        gridItem.className = "grid-item";
        gridItem.innerText = i;
        gridItem.addEventListener("click", function() {
          if (selectedScenarioIndex !== null) {
            selectedScenarioIndex.classList.remove("selected");
          }
          selectedScenarioIndex = this;
          this.classList.add("selected");
        });
        gridContainer.appendChild(gridItem);
      }

      // CLUTTER extraction button.
      var extractButton = document.getElementById("extract-dataset");
      extractButton.addEventListener("click", async function(event) {
        event.preventDefault();
        var realizationMinIndex = parseInt(document.getElementById("realization-min-index").value);
        var realizationMaxIndex = parseInt(document.getElementById("realization-max-index").value);
      
        if (!selectedDirectoryHandle) {
          alert("Please select a download directory first.");
          return;
        }
      
        if (selectedScenarioIndex !== null && !isNaN(realizationMinIndex) && !isNaN(realizationMaxIndex) &&
            realizationMinIndex > 0 && realizationMaxIndex <= 10000 && realizationMinIndex <= realizationMaxIndex) {
          var scenarioIndex = parseInt(selectedScenarioIndex.innerText);
          // Lookup for latitude and longitude.
          var latLonArray = [
            ["48.2995","-124.6272"],
            ["44.1917","-124.0905"],
            ["37.7856","-122.4431"],
            ["41.4168","-122.2015"],
            ["46.8483","-121.7566"],
            ["44.0991","-121.7425"],
            ["48.7358","-121.6756"],
            ["35.985","-121.4863"],
            ["38.9481","-120.0841"],
            ["44.9981","-120.0597"],
            ["36.6554","-119.9324"],
            ["34.4289","-119.767"],
            ["41.9174","-119.7279"],
            ["37.7408","-119.5601"],
            ["47.5126","-119.4791"],
            ["34.092","-118.6362"],
            ["36.5249","-118.4776"],
            ["46.8061","-117.549"],
            ["45.2452","-117.2928"],
            ["36.1558","-116.9164"],
            ["45.5724","-116.6787"],
            ["47.6693","-116.604"],
            ["48.154","-116.2233"],
            ["33.4282","-115.5721"],
            ["48.6336","-115.2953"],
            ["33.1031","-114.9343"],
            ["43.6881","-114.234"],
            ["48.091","-113.8537"],
            ["40.6391","-113.6525"],
            ["43.3357","-113.6419"],
            ["48.5934","-113.5835"],
            ["37.2973","-112.9073"],
            ["40.6958","-112.2119"],
            ["37.6477","-112.1292"],
            ["36.2069","-111.9628"],
            ["33.4143","-111.4949"],
            ["42.1479","-111.3145"],
            ["38.136","-110.831"],
            ["43.733","-110.757"],
            ["44.8686","-110.5484"],
            ["38.2498","-109.8142"],
            ["46.7789","-109.4308"],
            ["39.1789","-109.4223"],
            ["36.7282","-108.202"],
            ["39.5681","-107.5332"],
            ["35.1394","-106.4385"],
            ["41.2041","-106.0017"],
            ["38.8275","-104.9488"],
            ["31.8881","-104.8603"],
            ["47.6532","-104.6441"],
            ["32.9892","-103.8644"],
            ["44.0686","-103.7762"],
            ["30.0978","-103.5585"],
            ["29.2851","-103.2479"],
            ["43.8194","-102.3491"],
            ["35.3487","-101.8228"],
            ["47.1979","-99.8113"],
            ["41.5587","-99.2293"],
            ["26.8356","-98.4699"],
            ["37.9689","-97.575"],
            ["47.1179","-96.8311"],
            ["34.556","-95.6221"],
            ["36.1641","-93.6476"],
            ["34.7491","-92.1178"],
            ["47.2824","-91.2762"],
            ["46.6932","-90.8629"],
            ["45.5059","-90.8222"],
            ["33.8204","-90.7317"],
            ["30.5163","-87.8938"],
            ["46.5559","-87.4021"],
            ["38.6645","-86.895"],
            ["42.295","-86.3169"],
            ["34.4884","-85.4009"],
            ["45.7183","-84.7585"],
            ["36.1301","-84.3984"],
            ["35.4121","-84.1288"],
            ["43.6216","-83.8388"],
            ["41.6194","-83.1683"],
            ["35.6463","-82.8889"],
            ["38.0973","-82.647"],
            ["31.1162","-82.4694"],
            ["38.9185","-81.0876"],
            ["25.4352","-80.3665"],
            ["42.0964","-80.1729"],
            ["32.7996","-79.9423"],
            ["40.7","-79.6343"],
            ["39.96","-77.8444"],
            ["39.626","-77.4582"],
            ["43.4339","-76.4938"],
            ["37.84","-76.2766"],
            ["39.2179","-74.98"],
            ["44.1415","-73.987"],
            ["44.6815","-73.3225"],
            ["42.6295","-73.1617"],
            ["41.2875","-72.6079"],
            ["41.4469","-71.5895"],
            ["44.2682","-71.304"],
            ["42.3328","-71.0494"],
            ["44.9516","-70.4859"],
            ["41.7699","-70.0207"]
          ];
          var lat = latLonArray[scenarioIndex - 1][0];
          var lon = latLonArray[scenarioIndex - 1][1];
      
          // Build an array of URLs for the selected realization range.
          var customUrls = [];
          for (var j = realizationMinIndex; j <= realizationMaxIndex; j++) {
            customUrls.push(`https://g-297e98.1d0d8d.03c0.data.globus.org/CLUTTER/num${scenarioIndex}_lat${lat}_lon${lon}/real${j}.mat`);
          }
      
          // Create a subdirectory in the selected directory.
          try {
            var subDirName = `num${scenarioIndex}_lat${lat}_lon${lon}`;
            var subDirHandle = await selectedDirectoryHandle.getDirectoryHandle(subDirName, { create: true });
          } catch (error) {
            console.error("Failed to create subdirectory", error);
            alert("Error creating subdirectory.");
            return;
          }
      
          totalFiles = customUrls.length;
          processedFiles = 0;
          startTime = new Date();
          progressContainer.style.display = "block";
      
          // Sequentially fetch and write each file.
          for (const url of customUrls) {
            await fetchAndWrite(url, subDirHandle);
          }
      
          progressContainer.style.display = "none";
          progressBar.value = 0;
          timeInfo.innerText = "";
          alert("CLUTTER dataset extraction complete.");
        } else {
          alert("Please select a scenario index and fill out both realization indices with valid numbers.");
        }
      });

      // --- EXAMPLES Dataset Full Download (unchanged) ---
      var downloadButton = document.getElementById("full-download");
      downloadButton.addEventListener("click", function(event) {
        event.preventDefault();
        var zip = new JSZip();
        var scenarios = [29, 35, 60, 62, 76];
        var urls = [];
        scenarios.forEach(function(i) {
          urls.push(`https://g-297e98.1d0d8d.03c0.data.globus.org/EXAMPLES/num${i}_NAMF_DATA_20_rng30_pulse1_1000_100k.zip`);
          urls.push(`https://g-297e98.1d0d8d.03c0.data.globus.org/EXAMPLES/num${i}_Ground_Truth_20_rng30_1000_100k_m.csv`);
        });
        totalFiles = urls.length;
        processedFiles = 0;
        startTime = new Date();
        progressContainer.style.display = "block";
        Promise.all(urls.map(url =>
          fetch(url)
            .then(response => response.blob())
            .then(blob => {
              var fileName = url.split('/').pop();
              zip.file(fileName, blob);
              updateProgress();
            })
        ))
          .then(() => zip.generateAsync({ type: "blob", compression: "STORE" }))
          .then(content => {
            saveAs(content, "RASPNet_EXAMPLES.zip");
            progressContainer.style.display = "none";
            progressBar.value = 0;
            timeInfo.innerText = "";
          });
      });

      // --- CVNN Dataset Full Download (unchanged) ---
      var fullDownloadCvnn = document.getElementById("full-download-cvnn");
      fullDownloadCvnn.addEventListener("click", function(event) {
        event.preventDefault();
        var zipCvnn = new JSZip();
        var cvnnUrls = [
          "https://g-297e98.1d0d8d.03c0.data.globus.org/EXAMPLES/num29.zip",
          "https://g-297e98.1d0d8d.03c0.data.globus.org/EXAMPLES/num35.zip",
          "https://g-297e98.1d0d8d.03c0.data.globus.org/EXAMPLES/num60.zip",
          "https://g-297e98.1d0d8d.03c0.data.globus.org/EXAMPLES/num62.zip",
          "https://g-297e98.1d0d8d.03c0.data.globus.org/EXAMPLES/num76.zip"
        ];
        totalFiles = cvnnUrls.length;
        processedFiles = 0;
        startTime = new Date();
        progressContainer.style.display = "block";
        Promise.all(cvnnUrls.map(url =>
          fetch(url)
            .then(response => response.blob())
            .then(blob => {
              var fileName = url.split('/').pop();
              zipCvnn.file(fileName, blob);
              updateProgress();
            })
        ))
          .then(() => zipCvnn.generateAsync({ type: "blob", compression: "STORE" }))
          .then(content => {
            saveAs(content, "CVNN_Dataset.zip");
            progressContainer.style.display = "none";
            progressBar.value = 0;
            timeInfo.innerText = "";
          });
      });
    });
  </script>
  <script src="js/script.js"></script>
</body>
</html>
